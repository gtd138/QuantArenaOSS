<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>持仓数据诊断</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 2rem;
            margin: 0;
            background: #f5f5f5;
        }
        h1 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .mb-4 {
            margin-bottom: 1rem;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        #result {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .text-green-600 {
            color: #16a34a;
        }
        .text-blue-600 {
            color: #2563eb;
        }
        .text-red-600 {
            color: #dc2626;
        }
        .font-bold {
            font-weight: bold;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-xs {
            font-size: 0.75rem;
        }
        .mt-4 {
            margin-top: 1rem;
        }
        .mt-2 {
            margin-top: 0.5rem;
        }
        .p-4 {
            padding: 1rem;
        }
        .p-2 {
            padding: 0.5rem;
        }
        .border {
            border: 1px solid #e5e7eb;
        }
        .rounded {
            border-radius: 0.25rem;
        }
        .bg-gray-50 {
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <h1>持仓数据诊断</h1>
    
    <div class="mb-4">
        <button onclick="testHoldings()">
            测试持仓数据加载
        </button>
    </div>
    
    <div id="result"></div>
    
    <script>
        async function testHoldings() {
            const result = document.getElementById('result');
            result.innerHTML = '<div class="text-blue-600">正在加载...</div>';
            
            try {
                // 1. 获取API数据
                const resp = await fetch('http://localhost:8000/api/arena/data');
                const data = await resp.json();
                
                let html = '<div class="text-green-600 font-bold">✅ API请求成功</div>';
                html += `<div class="text-sm">模型数量: ${Object.keys(data).length}</div>`;
                
                // 2. 检查每个模型的holdings
                Object.keys(data).forEach(modelName => {
                    const modelData = data[modelName];
                    const holdings = Array.isArray(modelData.holdings) 
                        ? modelData.holdings 
                        : (modelData.holdings ? Object.values(modelData.holdings) : []);
                    
                    html += `<div class="mt-4 p-4 border rounded">`;
                    html += `<div class="font-bold">${modelName}</div>`;
                    html += `<div class="text-sm">holdings类型: ${typeof modelData.holdings}</div>`;
                    html += `<div class="text-sm">holdings数量: ${holdings.length}</div>`;
                    
                    if (holdings && holdings.length > 0) {
                        html += '<div class="text-green-600">✅ 有持仓数据</div>';
                        
                        // 测试计算盈亏
                        try {
                            const totalProfit = holdings.reduce((sum, h) => {
                                return sum + (h.current_price - h.cost) * h.amount;
                            }, 0);
                            html += `<div class="text-sm">总盈亏: ¥${totalProfit.toFixed(2)}</div>`;
                        } catch (err) {
                            html += `<div class="text-red-600">❌ 计算盈亏出错: ${err.message}</div>`;
                        }
                        
                        // 显示第1个持仓
                        const first = holdings[0];
                        html += '<div class="text-xs mt-2 bg-gray-50 p-2">';
                        html += `<div>第1个持仓:</div>`;
                        html += `<div>code: ${first.code}</div>`;
                        html += `<div>name: "${first.name}" (${first.name === null ? 'null' : typeof first.name})</div>`;
                        html += `<div>amount: ${first.amount}</div>`;
                        html += `<div>cost: ${first.cost}</div>`;
                        html += `<div>current_price: ${first.current_price}</div>`;
                        html += `<div>profit_pct: ${first.profit_pct}</div>`;
                        html += '</div>';
                    } else {
                        html += '<div class="text-red-600">❌ 无持仓数据</div>';
                    }
                    
                    html += '</div>';
                });
                
                result.innerHTML = html;
                
            } catch (err) {
                result.innerHTML = `<div class="text-red-600">❌ 错误: ${err.message}</div>`;
                console.error(err);
            }
        }
        
        // 自动执行
        testHoldings();
    </script>
</body>
</html>
